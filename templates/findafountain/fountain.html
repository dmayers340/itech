{% extends 'findafountain/base.html' %}
{% load staticfiles %}

{% block titleblock %}Home{% endblock %}

{% block title %}
	<h1>Find a Fountain</h1>
	<p class="lead"><b>Created by The Thirsty Pythons</b></p>
{% endblock %}

{% block content %}

<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<script type="text/javascript"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

<style>
 #map {
	   width: 100%;
	 }
</style>

<div class = "container-fluid">
	<div class = "row">

		<div class = "col-sm">
		<br/> <h2><b>{{fountain.name}}</b></h2> 
		<img width=300 height="auto" src='{{ MEDIA_URL}}{{fountain.image}}'/><br/> 
 		<hr>

 		{% if fountain.avgrating%}
 		<b> Rating: </b>

			 <div id ="rating" style="font-size:1.5em; color: gold "> 


			<script type="text/javascript"> 
					printRating();
					function printRating() {
		   			var x ="", i;
		   			for (i=1; i<={{fountain.avgrating}}; i++) {
		       			 x = x + "<i class='fas fa-star'></i> ";  
		   			 }		
		    		document.getElementById("rating").innerHTML = x;
				}
			</script>

			</div>
		{% else %}
			There aren't any ratings yet. <br/>
		{% endif %}


			Reviews: {{reviews|length}}  

			<br/>

			<hr> {{fountain.description}} <br/> <hr>
			<b>Building: </b>{{fountain.building}} <br/>
			<b>Floor: </b>{{fountain.floor}} <br/>
			<b>Broken: </b>

			{% if fountain.broken %}
			Yes 
			{% else %}
			No
			{% endif %}

			<br/><br/>

			</div>

		<div class="col-6" style="border: 1px solid white;">

			<br/> 
			<div id="map">
				 <script type="text/javascript">

				 var map, marker;
				 var geoLocatorMarker, geoLocatorInfoWindow;
				 var directionsService, directionsDisplay, currentLat, currentLng, currentPosition;
				 var campus;

				function initMap() {
				 	  map = new google.maps.Map(document.getElementById('map'), {
					  mapTypeId: google.maps.MapTypeId.ROADMAP,
					  });

					campus  = new google.maps.LatLng(55.872084,-4.288222);
					map.setCenter(campus);

					directionsDisplay = new google.maps.DirectionsRenderer();
					directionsService = new google.maps.DirectionsService();

					loadLocation(); 
					locateUser(); 
				}

				function loadLocation(){

					marker = new google.maps.Marker({
						position: new google.maps.LatLng({{fountain.lat}}, {{fountain.lng}}),
						map: map,
						icon: {url: "{% static 'img/icon.svg' %}",
						scaledSize: new google.maps.Size(60, 50)},
						visible: true
					  });

				}

				function calcRoute(directionsService, directionsDisplay) {
						
					directionsDisplay.setMap(map);

					var request = {
						origin: new google.maps.LatLng(currentPosition),
						destination: new google.maps.LatLng({{fountain.lat}},{{fountain.lng}}),
						travelMode: 'WALKING'
					};
					
					directionsService.route(request, function(result, status) { 
							if (status == 'OK') {
							directionsDisplay.setOptions({ preserveViewport: true });
							directionsDisplay.setDirections(result);
						}  
					});

					map.setZoom(17);
					map.setCenter(new google.maps.LatLng({{fountain.lat}},{{fountain.lng}}));

				}

				function locateUser(){ 
					if (navigator.geolocation) {

					  navigator.geolocation.getCurrentPosition(function(position) {
						currentPosition = {
						  lat: position.coords.latitude,
						  lng: position.coords.longitude
						};

						currentLat = position.coords.latitude;
						currentLng = position.coords.longitude;

						var pos = new google.maps.LatLng(currentPosition);
						geoLocatorInfoWindow = new google.maps.InfoWindow;
						geoLocatorMarker = new google.maps.Marker({map: map});

						geoLocatorMarker.setPosition(pos);
						geoLocatorInfoWindow.setContent('Your location');
						geoLocatorInfoWindow.open(map, geoLocatorMarker);

						calcRoute(directionsService, directionsDisplay); 

					}, function() {
					handleLocationError(true, geoLocatorInfoWindow);
					});
					} else {
					  // Browser doesn't support Geolocation
					  handleLocationError(false, geoLocatorInfoWindow);
					}
				}

				function handleLocationError(browserHasGeolocation, geoLocatorInfoWindow) {	
					var errorposition = new google.maps.LatLng({{fountain.lat}}, {{fountain.lng}});
					geoLocatorInfoWindow = new google.maps.InfoWindow;
					geoLocatorInfoWindow.setPosition(errorposition);
					geoLocatorInfoWindow.setContent( 'Error: The Geolocation service failed.Your browser doesn\'t support geolocation.'); 
					geoLocatorInfoWindow.open(map);
				}

		</script>

		<script async defer
					src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALaN1AQdFvEnlLyNLdHUmYKSjX5C82B4I&callback=initMap">
		</script>

	
		</div><br/> 

		</div>
	
		<div class = "col-sm2" style="max-width: 400px; max-height: 700px; padding:20px; border: 1px solid white;" >

			<h2><b>Reviews</b></h2><hr>
			
			<div class = "col-sm2" style="max-height: 300px; overflow:auto;padding: 15px; border: 1px solid gainsboro;" >

					{% if reviews %}
					{% for review in reviews %}
					<img width='75' src='{{MEDIA_URL}}{{review.user.picture}}' align="left" style="padding: 0 10px 0 0px"/>
					<div style="text-align:left"> <b> "{{review.title}}" </b> <br/>
					<b> {{review.user}}</b>, <font style ="color:gray"> {{review.datetime}}</font>
					{{review.text}}<br/> </div><hr>
					{% endfor %}
					{% else %}
					This fountain has no reviews. <hr>
					{% endif %}
				
			</div> 

		<div>

			<hr> 
			<h2><b>Leave a review</b></h2>
			<form id="review" method="post" enctype="multipart/form-data">
				 
				<div align=center>
					{% csrf_token %}
					<b> {{ review_form.as_p }} </b>
				</div>

				<button type="submit" class="btn-custom" alt="Submit a review">
						<b>	Submit a review </b>
				</button> 	
			</form>

			<form id="rate" method="post">

					<button type="submit" class="btn-custom" alt="Submit a rating">
						Submit
					</button> 
				
						{% csrf_token %}
						{{ rating_form }}
			</form>

		<br/>

		
		<button type="report" class="btn-custom-red" alt="Report broken">
		<b>	Report a broken fountain</b>
		</button>

		</div>

	</div>

</div>

{% endblock %}